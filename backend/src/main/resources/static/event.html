<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>MeetHive Events</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;700;800&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              "primary": "#f9d006",
              "background-light": "#ffffff",
              "background-dark": "#231f0f",
            },
            fontFamily: {
              "display": ["Plus Jakarta Sans", "sans-serif"]
            },
            borderRadius: {
              "DEFAULT": "0.25rem",
              "lg": "0.5rem",
              "xl": "0.75rem",
              "full": "9999px"
            },
          },
        },
      }
    </script>
<style>
      .material-symbols-outlined {
        font-variation-settings:
          'FILL' 0,
          'wght' 400,
          'GRAD' 0,
          'opsz' 24
      }
    </style>
</head>
<body class="bg-background-light font-display text-gray-800">
<div class="flex flex-col min-h-screen">
<header class="sticky top-0 z-10 bg-background-light/80 backdrop-blur-sm border-b border-black/10">
<div class="container mx-auto px-4 sm:px-6 lg:px-8">
<div class="flex items-center justify-between h-16">
<div class="flex items-center gap-2">
<svg class="h-8 w-8 text-primary" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M21.43,12.27,13,3.84a1,1,0,0,0-1.41,0L2.57,12.27a1,1,0,0,0-.29.71,1,1,0,0,0,1,1H6v6a1,1,0,0,0,1,1h4V16h2v4h4a1,1,0,0,0,1-1V13.92h2.67a1,1,0,0,0,.71-1.71Z"></path>
</svg>
<h1 class="text-xl font-bold text-gray-900">MeetHive Events</h1>
</div>
<nav class="hidden md:flex items-center gap-6">
<a class="text-sm font-medium text-gray-700 hover:text-primary transition-colors" href="dashboard.html">Home</a>
<a class="text-sm font-medium text-primary" href="event.html">My Events</a>
<button id="create-event-btn" class="text-sm font-medium text-gray-700 hover:text-primary transition-colors">Create Event</button>
</nav>
</div>
</div>
</header>
<main class="flex-grow container mx-auto px-4 sm:px-6 lg:px-8 py-8">
<div class="mb-4">
<select id="group-filter" class="px-4 py-2 border rounded-lg">
<option value="">All Groups</option>
</select>
</div>
<div id="events-list" class="grid grid-cols-1 gap-6"></div>
</main>
</div>

<div id="event-form-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
<div class="bg-white rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
<h3 id="form-title" class="text-2xl font-bold mb-4">Create Event</h3>
<form id="event-form" class="space-y-4">
<div>
<label class="block text-sm font-bold mb-2">Title</label>
<input id="event-title" class="w-full border rounded-lg px-3 py-2" required type="text"/>
</div>
<div>
<label class="block text-sm font-bold mb-2">Description</label>
<textarea id="event-description" class="w-full border rounded-lg px-3 py-2" required rows="3"></textarea>
</div>
<div>
<label class="block text-sm font-bold mb-2">Date & Time</label>
<input id="event-datetime" class="w-full border rounded-lg px-3 py-2" required type="datetime-local"/>
</div>
<div>
<label class="block text-sm font-bold mb-2">Location</label>
<input id="event-location" class="w-full border rounded-lg px-3 py-2" type="text"/>
</div>
<div>
<label class="block text-sm font-bold mb-2">Group</label>
<select id="event-group-select" class="w-full border rounded-lg px-3 py-2" required>
<option value="">Select a group</option>
</select>
</div>
<div>
<label class="block text-sm font-bold mb-2">üîî Reminder</label>
<select id="event-reminder" class="w-full border rounded-lg px-3 py-2">
<option value="">No reminder</option>
<option value="5">5 minutes before</option>
<option value="15">15 minutes before</option>
<option value="30">30 minutes before</option>
<option value="60">1 hour before</option>
<option value="1440">1 day before</option>
</select>
</div>
<div class="flex gap-2">
<button type="submit" class="flex-1 bg-primary text-black px-4 py-2 rounded-lg font-bold">Save</button>
<button type="button" id="cancel-event-btn" class="flex-1 bg-gray-200 text-black px-4 py-2 rounded-lg font-bold">Cancel</button>
</div>
</form>
</div>
</div>

<script>
if (!sessionStorage.getItem('jwt_token')) window.location.href = 'login.html';

let editingEventId = null;
const token = sessionStorage.getItem('jwt_token');
const currentUser = JSON.parse(sessionStorage.getItem('current_user')) || {};

async function api(endpoint, method = 'GET', body = null) {
    const options = {
        method, 
        headers: { 
            'Content-Type': 'application/json', 
            'Authorization': `Bearer ${token}` 
        }
    };
    if (body && method !== 'GET') {
        options.body = JSON.stringify(body);
    }
    const res = await fetch(`http://localhost:8080/api${endpoint}`, options);
    if (!res.ok) throw new Error(`API failed: ${res.status}`);
    return res.json();
}

async function loadRSVPs(eventId, organizerId) {
    try {
        const rsvps = await api(`/events/${eventId}/rsvps`);
        
        const attending = rsvps.filter(r => r.status === 'ATTENDING').length;
        const notAttending = rsvps.filter(r => r.status === 'NOT_ATTENDING').length;
        const maybe = rsvps.filter(r => r.status === 'MAYBE').length;
        
        const rsvpDiv = document.getElementById(`rsvp-${eventId}`);
        
        if (rsvpDiv && organizerId === currentUser.id) {
            rsvpDiv.innerHTML = `
                <span class="text-green-600 font-medium">‚úì ${attending} Going</span> ‚Ä¢ 
                <span class="text-red-600 font-medium">‚úó ${notAttending} Not Going</span> ‚Ä¢ 
                <span class="text-yellow-600 font-medium">? ${maybe} Maybe</span>
            `;
        } else if (rsvpDiv) {
            rsvpDiv.innerHTML = '';
        }
    } catch(e) {
        console.error('Failed to load RSVPs:', e);
    }
}

async function loadEvents() {
    try {
        const events = await api(`/events/user?userId=${currentUser.id}`);
        const list = document.getElementById('events-list');
        list.innerHTML = events.length ? '' : '<div class="col-span-full text-center p-10"><p class="text-gray-500">No events yet. Create one!</p></div>';
        events.forEach(e => {
            const div = document.createElement('div');
            div.className = 'event-card p-6 bg-white rounded-xl border shadow-sm hover:shadow-md transition-shadow';
            div.dataset.groupId = e.groupId;
            div.dataset.organizerId = e.organizerId; // Store organizer ID for polling
            
            const eventDate = new Date(e.dateTime);
            const formattedDate = eventDate.toLocaleString('en-US', {
                weekday: 'short',
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            div.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <h3 class="text-xl font-bold">${e.title}</h3>
                            <span class="text-xs bg-primary px-2 py-1 rounded font-medium">${e.groupName || 'Unknown Group'}</span>
                        </div>
                        <p class="text-gray-600 mb-2">üìÖ ${formattedDate}</p>
                        ${e.location ? `<p class="text-sm text-gray-500 mb-2">üìç ${e.location}</p>` : ''}
                        <p class="text-gray-700 mt-3">${e.description}</p>
                    </div>
                    <div class="flex gap-2 ml-4">
                        <button class="edit-btn px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600 transition-colors" data-id="${e.id}">Edit</button>
                        <button class="delete-btn px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600 transition-colors" data-id="${e.id}">Delete</button>
                    </div>
                </div>
                <div class="border-t pt-4">
                    <p class="text-sm font-bold text-gray-700 mb-2">Your Response:</p>
                    <div class="flex gap-2 mb-3">
                        <button class="rsvp-btn px-4 py-2 rounded text-sm font-medium bg-green-500 text-white hover:bg-green-600 transition-colors" 
                                data-event-id="${e.id}" data-status="ATTENDING">
                            ‚úì Yes, I'm in!
                        </button>
                        <button class="rsvp-btn px-4 py-2 rounded text-sm font-medium bg-red-500 text-white hover:bg-red-600 transition-colors" 
                                data-event-id="${e.id}" data-status="NOT_ATTENDING">
                            ‚úó Sorry, maybe next time
                        </button>
                        <button class="rsvp-btn px-4 py-2 rounded text-sm font-medium bg-yellow-500 text-white hover:bg-yellow-600 transition-colors" 
                                data-event-id="${e.id}" data-status="MAYBE">
                            ? Let me check and tell
                        </button>
                    </div>
                    <div id="rsvp-${e.id}" class="text-sm text-gray-600"></div>
                </div>
            `;
            
            div.querySelector('.edit-btn').onclick = () => editEvent(e);
            div.querySelector('.delete-btn').onclick = () => deleteEvent(e.id);
            
            div.querySelectorAll('.rsvp-btn').forEach(btn => {
                btn.onclick = async () => {
                    try {
                        await api(`/events/${btn.dataset.eventId}/rsvp`, 'POST', { 
                            status: btn.dataset.status,
                            userId: currentUser.id.toString()
                        });
                        
                        btn.classList.add('ring-2', 'ring-white', 'scale-95');
                        setTimeout(() => {
                            btn.classList.remove('ring-2', 'ring-white', 'scale-95');
                        }, 300);
                        
                        loadRSVPs(btn.dataset.eventId, e.organizerId);
                    } catch(err) {
                        console.error('RSVP error:', err);
                        alert('Failed to update RSVP. Please try again.');
                    }
                };
            });
            
            list.appendChild(div);
            loadRSVPs(e.id, e.organizerId);
        });
    } catch (e) {
        console.error('Error loading events:', e);
        document.getElementById('events-list').innerHTML = '<div class="col-span-full text-center p-10"><p class="text-red-500">Failed to load events</p></div>';
    }
}

async function loadGroups() {
    try {
        const groups = await api(`/groups/user/${currentUser.id}`);
        const select = document.getElementById('event-group-select');
        const filter = document.getElementById('group-filter');
        
        select.innerHTML = '<option value="">Select a group</option>';
        filter.innerHTML = '<option value="">All Groups</option>';
        
        groups.forEach(g => {
            select.innerHTML += `<option value="${g.id}">${g.name}</option>`;
            filter.innerHTML += `<option value="${g.id}">${g.name}</option>`;
        });
        
        if (groups.length === 0) {
            select.innerHTML = '<option value="">No groups available</option>';
            select.disabled = true;
        }
    } catch (e) {
        console.error('Error loading groups:', e);
    }
}

document.getElementById('create-event-btn').onclick = () => {
    document.getElementById('event-form-modal').classList.remove('hidden');
    document.getElementById('form-title').textContent = 'Create Event';
    document.getElementById('event-form').reset();
    editingEventId = null;
};

document.getElementById('cancel-event-btn').onclick = () => {
    document.getElementById('event-form-modal').classList.add('hidden');
};

document.getElementById('event-form').onsubmit = async (e) => {
    e.preventDefault();
    
    const datetimeValue = document.getElementById('event-datetime').value;
    const localDateTime = new Date(datetimeValue);
    const isoDateTime = localDateTime.toISOString();
    
    const data = {
        title: document.getElementById('event-title').value.trim(),
        description: document.getElementById('event-description').value.trim(),
        dateTime: isoDateTime,
        location: document.getElementById('event-location').value.trim(),
        groupId: parseInt(document.getElementById('event-group-select').value),
        organizerId: currentUser.id
    };
    
    if (!data.title || !data.description || !data.groupId) {
        alert('Please fill in all required fields');
        return;
    }
    
    try {
        if (editingEventId) {
            await api(`/events/${editingEventId}`, 'PUT', data);
        } else {
            await api('/events', 'POST', data);
        }
        document.getElementById('event-form-modal').classList.add('hidden');
        loadEvents();
    } catch (err) {
        console.error('Error saving event:', err);
        alert('Failed to save event. Please try again.');
    }
};

function editEvent(event) {
    editingEventId = event.id;
    document.getElementById('form-title').textContent = 'Edit Event';
    document.getElementById('event-title').value = event.title;
    document.getElementById('event-description').value = event.description;
    
    const eventDate = new Date(event.dateTime);
    const year = eventDate.getFullYear();
    const month = String(eventDate.getMonth() + 1).padStart(2, '0');
    const day = String(eventDate.getDate()).padStart(2, '0');
    const hours = String(eventDate.getHours()).padStart(2, '0');
    const minutes = String(eventDate.getMinutes()).padStart(2, '0');
    const formattedDateTime = `${year}-${month}-${day}T${hours}:${minutes}`;
    
    document.getElementById('event-datetime').value = formattedDateTime;
    document.getElementById('event-location').value = event.location || '';
    document.getElementById('event-group-select').value = event.groupId;
    document.getElementById('event-form-modal').classList.remove('hidden');
}

async function deleteEvent(id) {
    if (!confirm('Are you sure you want to delete this event?')) return;
    try {
        await api(`/events/${id}`, 'DELETE');
        loadEvents();
    } catch (e) {
        console.error('Error deleting event:', e);
        alert('Failed to delete event');
    }
}

document.getElementById('group-filter').onchange = (e) => {
    const groupId = e.target.value;
    document.querySelectorAll('.event-card').forEach(card => {
        card.style.display = !groupId || card.dataset.groupId === groupId ? 'block' : 'none';
    });
};

loadGroups();
loadEvents();


setInterval(() => {
    const eventCards = document.querySelectorAll('.event-card');
    eventCards.forEach(card => {
        const rsvpDiv = card.querySelector('[id^="rsvp-"]');
        if (rsvpDiv) {
            const eventId = rsvpDiv.id.replace('rsvp-', '');
            const organizerId = parseInt(card.dataset.organizerId);
            if (organizerId === currentUser.id) {
                loadRSVPs(eventId, organizerId);
            }
        }
    });
}, 1000); 
</script>
</body></html>