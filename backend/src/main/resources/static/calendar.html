<!DOCTYPE html>
<html class="light" lang="en"><head>
<meta charset="utf-8"/>
<title>MeetHive Calendar</title>
<link crossorigin="" href="https://fonts.gstatic.com/" rel="preconnect"/>
<link as="style" href="https://fonts.googleapis.com/css2?display=swap&amp;family=Plus+Jakarta+Sans:wght@400;500;700;800" onload="this.rel='stylesheet'" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#f9d006",
            "background-light": "#ffffff",
            "background-dark": "#231f0f",
          },
          fontFamily: {
            "display": ["Plus Jakarta Sans"]
          },
          borderRadius: {
            "DEFAULT": "0.25rem",
            "lg": "0.5rem",
            "xl": "0.75rem",
            "full": "9999px"
          },
        },
      },
    }
  </script>
<style>
    .material-symbols-outlined {
      font-variation-settings:
        'FILL' 0,
        'wght' 400,
        'GRAD' 0,
        'opsz' 24
    }
    .day-btn {
      position: relative;
    }
    .event-dot {
      position: absolute;
      bottom: 2px;
      left: 50%;
      transform: translateX(-50%);
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }
    .event-dot.past {
      background-color: #9ca3af;
    }
    .event-dot.today {
      background-color: #ef4444;
    }
    .event-dot.upcoming {
      background-color: #3b82f6;
    }
  </style>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
</head>
<body class="bg-background-light font-display text-slate-800">
<div class="flex h-full min-h-screen w-full flex-col items-center">
<div class="w-full max-w-7xl">
<header class="flex items-center justify-between whitespace-nowrap border-b border-primary/20 px-4 py-4 sm:px-6 lg:px-8">
<div class="flex items-center gap-2">
<div class="h-8 w-8 text-primary">
<svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
<path clip-rule="evenodd" d="M47.2426 24L24 47.2426L0.757355 24L24 0.757355L47.2426 24ZM12.2426 21H35.7574L24 9.24264L12.2426 21Z" fill="currentColor" fill-rule="evenodd"></path>
</svg>
</div>
<h1 class="text-lg font-bold text-slate-900">MeetHive</h1>
</div>
<nav class="hidden items-center gap-8 md:flex">
<a class="text-sm font-medium text-slate-700 hover:text-primary" href="dashboard.html">Home</a>
<a class="text-sm font-medium text-primary" href="calendar.html">Calendar</a>
<a class="text-sm font-medium text-slate-700 hover:text-primary" href="chat.html">Chats</a>
<a class="text-sm font-medium text-slate-700 hover:text-primary" href="event.html">Events</a>
</nav>
</div>
</header>
<main class="flex flex-1 flex-col items-center p-4 py-8 sm:p-6 lg:p-8">
<div class="w-full max-w-4xl">
<div class="mb-8 text-center">
<h2 class="text-3xl font-bold text-slate-900">MeetHive Calendar</h2>
<p class="text-sm text-gray-600 mt-2">Events from your groups</p>
</div>
<div class="rounded-xl bg-background-light p-4 shadow-lg shadow-primary/10 sm:p-6">
<div class="mb-4 flex items-center justify-between">
<button id="prev-month-btn" class="rounded-full p-2 text-slate-600 hover:bg-primary/20 transition-colors">
<span class="material-symbols-outlined">chevron_left</span>
</button>
<h3 id="month-year" class="text-lg font-bold text-slate-900"></h3>
<button id="next-month-btn" class="rounded-full p-2 text-slate-600 hover:bg-primary/20 transition-colors">
<span class="material-symbols-outlined">chevron_right</span>
</button>
</div>
<div id="calendar-grid" class="grid grid-cols-7 gap-1 text-center"></div>
</div>
<div class="mt-4 text-center text-sm text-gray-600">
<div class="inline-flex items-center gap-6">
<span class="inline-flex items-center gap-2">
<span class="w-3 h-3 bg-gray-400 rounded-full"></span>
Past events
</span>
<span class="inline-flex items-center gap-2">
<span class="w-3 h-3 bg-red-500 rounded-full"></span>
Today's events
</span>
<span class="inline-flex items-center gap-2">
<span class="w-3 h-3 bg-blue-500 rounded-full"></span>
Upcoming events
</span>
</div>
</div>
</div>
</main>
</div>
</div>

<div id="day-events-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50">
<div class="bg-white rounded-xl p-6 w-full max-w-2xl max-h-[80vh] overflow-y-auto">
<div class="flex justify-between items-center mb-4">
<h3 id="modal-day-title" class="text-2xl font-bold"></h3>
<button id="close-modal-btn" class="text-gray-500 hover:text-black text-2xl">&times;</button>
</div>
<div id="modal-events-list"></div>
</div>
</div>

<script>
if (!sessionStorage.getItem('jwt_token')) window.location.href = 'login.html';

const token = sessionStorage.getItem('jwt_token');
const currentUser = JSON.parse(sessionStorage.getItem('current_user')) || {};

let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();
let allEvents = [];
let notifiedEvents = new Set();

async function api(endpoint) {
    const res = await fetch(`http://localhost:8080/api${endpoint}`, {
        headers: { 
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        }
    });
    if (!res.ok) throw new Error(`API failed: ${res.status}`);
    return res.json();
}

async function loadEvents() {
    try {
        allEvents = await api(`/events/user?userId=${currentUser.id}`);
        console.log('Loaded events:', allEvents.length);
        renderCalendar();
    } catch (e) {
        console.error('Failed to load events:', e);
        allEvents = [];
        renderCalendar();
    }
}

function getEventStatus(eventDateTime) {
    const now = new Date();
    const eventDate = new Date(eventDateTime);
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const eventDay = new Date(eventDate.getFullYear(), eventDate.getMonth(), eventDate.getDate());
    
    if (eventDay < today) {
        return 'past';
    } else if (eventDay.getTime() === today.getTime()) {
        return 'today';
    } else {
        return 'upcoming';
    }
}

function getEventsForDate(day) {
    return allEvents.filter(e => {
        const d = new Date(e.dateTime);
        return d.getFullYear() === currentYear && d.getMonth() === currentMonth && d.getDate() === day;
    });
}

function renderCalendar() {
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    document.getElementById('month-year').textContent = `${monthNames[currentMonth]} ${currentYear}`;
    
    const grid = document.getElementById('calendar-grid');
    grid.innerHTML = '';
    
    const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    dayNames.forEach(day => {
        const div = document.createElement('div');
        div.className = 'p-2 text-xs font-bold uppercase text-slate-500';
        div.textContent = day;
        grid.appendChild(div);
    });
    
    const firstDay = new Date(currentYear, currentMonth, 1).getDay();
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    
    for (let i = 0; i < firstDay; i++) {
        grid.appendChild(document.createElement('div'));
    }
    
    const today = new Date();
    const isCurrentMonth = currentMonth === today.getMonth() && currentYear === today.getFullYear();
    
    for (let day = 1; day <= daysInMonth; day++) {
        const dayDiv = document.createElement('div');
        dayDiv.className = 'p-1';
        
        const btn = document.createElement('button');
        const isToday = isCurrentMonth && day === today.getDate();
        btn.className = `day-btn flex h-10 w-10 items-center justify-center rounded-full text-sm font-medium transition-colors ${isToday ? 'bg-primary text-black font-bold' : 'text-slate-700 hover:bg-primary/20'}`;
        btn.textContent = day;
        
        const dayEvents = getEventsForDate(day);
        if (dayEvents.length > 0) {
            const statuses = dayEvents.map(e => getEventStatus(e.dateTime));
            let dotClass = 'event-dot ';
            
            if (statuses.includes('today')) {
                dotClass += 'today';
            } else if (statuses.includes('upcoming')) {
                dotClass += 'upcoming';
            } else {
                dotClass += 'past';
            }
            
            const dot = document.createElement('span');
            dot.className = dotClass;
            btn.appendChild(dot);
        }
        
        btn.onclick = () => showDayEvents(day, dayEvents);
        dayDiv.appendChild(btn);
        grid.appendChild(dayDiv);
    }
}

function showDayEvents(day, events) {
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    document.getElementById('modal-day-title').textContent = `${monthNames[currentMonth]} ${day}, ${currentYear}`;
    
    const list = document.getElementById('modal-events-list');
    list.innerHTML = events.length ? '' : '<p class="text-gray-500 text-center py-8">No events on this day</p>';
    
    events.forEach(e => {
        const div = document.createElement('div');
        const status = getEventStatus(e.dateTime);
        const isPast = status === 'past';
        
        div.className = `p-4 bg-white border rounded-lg mb-3 hover:shadow-md transition-shadow ${isPast ? 'opacity-60' : ''}`;
        
        const eventDate = new Date(e.dateTime);
        const timeStr = eventDate.toLocaleTimeString('en-US', { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: true 
        });
        
        let statusBadge = '';
        if (status === 'past') {
            statusBadge = '<span class="text-xs bg-gray-200 text-gray-600 px-2 py-1 rounded ml-2">Past</span>';
        } else if (status === 'today') {
            statusBadge = '<span class="text-xs bg-red-500 text-white px-2 py-1 rounded ml-2 animate-pulse">üî¥ Today</span>';
        } else {
            statusBadge = '<span class="text-xs bg-blue-500 text-white px-2 py-1 rounded ml-2">Upcoming</span>';
        }
        
        div.innerHTML = `
            <div class="flex items-center gap-2 mb-1">
                <h4 class="font-bold text-lg">${e.title}</h4>
                <span class="text-xs bg-primary px-2 py-1 rounded font-medium">${e.groupName || 'Group'}</span>
                ${statusBadge}
            </div>
            <p class="text-sm text-gray-600">üïê ${timeStr}</p>
            ${e.location ? `<p class="text-sm text-gray-500 mt-1">üìç ${e.location}</p>` : ''}
            <p class="text-sm text-gray-700 mt-2">${e.description}</p>
        `;
        list.appendChild(div);
    });
    
    document.getElementById('day-events-modal').classList.remove('hidden');
}

document.getElementById('close-modal-btn').onclick = () => {
    document.getElementById('day-events-modal').classList.add('hidden');
};

document.getElementById('prev-month-btn').onclick = () => {
    currentMonth--;
    if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
    }
    renderCalendar();
};

document.getElementById('next-month-btn').onclick = () => {
    currentMonth++;
    if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
    }
    renderCalendar();
};

if ("Notification" in window) {
    if (Notification.permission === "default") {
        Notification.requestPermission().then(permission => {
            if (permission === "granted") {
                console.log("Notifications enabled");
            }
        });
    }
}

function showNotification(event) {
    if (Notification.permission === "granted") {
        const eventDate = new Date(event.dateTime);
        const timeStr = eventDate.toLocaleTimeString('en-US', { 
            hour: '2-digit', 
            minute: '2-digit',
            hour12: true 
        });
        
        const now = new Date();
        const minutesUntil = Math.floor((eventDate - now) / 60000);
        
        new Notification(`üîî ${event.title}`, {
            body: `Starting in ${minutesUntil} minute${minutesUntil !== 1 ? 's' : ''} at ${timeStr}\n${event.location ? 'üìç ' + event.location : ''}\nGroup: ${event.groupName || 'Unknown'}`,
            requireInteraction: false,
            tag: `event-${event.id}`,
            vibrate: [200, 100, 200]
        });
    }
}

function checkReminders() {
    if (Notification.permission !== "granted") return;
    
    const now = new Date();
    
    allEvents.forEach(event => {
        const eventTime = new Date(event.dateTime);
        const timeDiff = eventTime - now;
        const minutesUntil = Math.floor(timeDiff / 60000);
        
        if (minutesUntil < 0) return;
        
        if (event.reminderMinutes) {
            const notificationKey = `${event.id}-custom`;
            
            if (minutesUntil <= event.reminderMinutes && 
                minutesUntil >= (event.reminderMinutes - 1) && 
                !notifiedEvents.has(notificationKey)) {
                
                showNotification(event);
                notifiedEvents.add(notificationKey);
                console.log(`Custom reminder sent: ${event.title} in ${minutesUntil} minutes`);
            }
        } else {
            const defaultReminderTimes = [30, 15, 5];
            
            defaultReminderTimes.forEach(reminderMinutes => {
                const notificationKey = `${event.id}-${reminderMinutes}`;
                
                if (minutesUntil <= reminderMinutes && 
                    minutesUntil >= (reminderMinutes - 1) && 
                    !notifiedEvents.has(notificationKey)) {
                    
                    showNotification(event);
                    notifiedEvents.add(notificationKey);
                    console.log(`Default reminder sent: ${event.title} in ${minutesUntil} minutes`);
                }
            });
        }
        
        if (minutesUntil < -60) {
            notifiedEvents.delete(`${event.id}-custom`);
            [30, 15, 5].forEach(reminderMinutes => {
                notifiedEvents.delete(`${event.id}-${reminderMinutes}`);
            });
        }
    });
}

setInterval(checkReminders, 60000);

loadEvents();
checkReminders();

setInterval(loadEvents, 300000);
</script>
</body></html>